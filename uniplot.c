#include <stdlib.h>
#include <stdio.h>
#include <ctype.h>
#include <string.h>
#include "iplot.h"
#include "uniplot.h"


int     mode = ALPHA;
int     blank = 0;
int     ox, x, ex, oy, y;
int     Flashcount = 0;
int     Chars = 0;
int     Pendown = 0;

int     CharSpacing[] = {56, 56, 51, 31, 23};
int     LineSpacing[] = {88, 88, 82, 48, 36};

void
Screeninit()
{
	register j, k;
	mode = ALPHA;
	Npoints = Nvectors = Pendown = Nex = oy = y = x = ox = 0;
	for (j = SSIZE; --j > 0;)
		for (k = SSIZE; --k >= 0;)
			Screen[k][j] = 0;
}
/*****************************************************************************
 * Ascii 8 by 8 regular font - only first 128 characters are supported.
 ****************************************************************************/

/*
 * Each array entry holds the bits for 8 horizontal scan lines, topmost
 * first.  The most significant bit of each constant is the leftmost bit of
 * the scan line.
 */
unsigned char AsciiTable[][8] = {
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},	/* Ascii 0 */
	{0x3c, 0x42, 0xa5, 0x81, 0xbd, 0x42, 0x3c, 0x00},	/* Ascii 1 */
	{0x3c, 0x7e, 0xdb, 0xff, 0xc3, 0x7e, 0x3c, 0x00},	/* Ascii 2 */
	{0x00, 0xee, 0xfe, 0xfe, 0x7c, 0x38, 0x10, 0x00},	/* Ascii 3 */
	{0x10, 0x38, 0x7c, 0xfe, 0x7c, 0x38, 0x10, 0x00},	/* Ascii 4 */
	{0x00, 0x3c, 0x18, 0xff, 0xff, 0x08, 0x18, 0x00},	/* Ascii 5 */
	{0x10, 0x38, 0x7c, 0xfe, 0xfe, 0x10, 0x38, 0x00},	/* Ascii 6 */
	{0x00, 0x00, 0x18, 0x3c, 0x18, 0x00, 0x00, 0x00},	/* Ascii 7 */
	{0xff, 0xff, 0xe7, 0xc3, 0xe7, 0xff, 0xff, 0xff},	/* Ascii 8 */
	{0x00, 0x3c, 0x42, 0x81, 0x81, 0x42, 0x3c, 0x00},	/* Ascii 9 */
	{0xff, 0xc3, 0xbd, 0x7e, 0x7e, 0xbd, 0xc3, 0xff},	/* Ascii 10 */
	{0x1f, 0x07, 0x0d, 0x7c, 0xc6, 0xc6, 0x7c, 0x00},	/* Ascii 11 */
	{0x00, 0x7e, 0xc3, 0xc3, 0x7e, 0x18, 0x7e, 0x18},	/* Ascii 12 */
	{0x04, 0x06, 0x07, 0x04, 0x04, 0xfc, 0xf8, 0x00},	/* Ascii 13 */
	{0x0c, 0x0a, 0x0d, 0x0b, 0xf9, 0xf9, 0x1f, 0x1f},	/* Ascii 14 */
	{0x00, 0x92, 0x7c, 0x44, 0xc6, 0x7c, 0x92, 0x00},	/* Ascii 15 */
	{0x00, 0x00, 0x60, 0x78, 0x7e, 0x78, 0x60, 0x00},	/* Ascii 16 */
	{0x00, 0x00, 0x06, 0x1e, 0x7e, 0x1e, 0x06, 0x00},	/* Ascii 17 */
	{0x18, 0x7e, 0x18, 0x18, 0x18, 0x18, 0x7e, 0x18},	/* Ascii 18 */
	{0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x66, 0x00},	/* Ascii 19 */
	{0xff, 0xb6, 0x76, 0x36, 0x36, 0x36, 0x36, 0x00},	/* Ascii 20 */
	{0x7e, 0xc1, 0xdc, 0x22, 0x22, 0x1f, 0x83, 0x7e},	/* Ascii 21 */
	{0x00, 0x00, 0x00, 0x7e, 0x7e, 0x00, 0x00, 0x00},	/* Ascii 22 */
	{0x18, 0x7e, 0x18, 0x18, 0x7e, 0x18, 0x00, 0xff},	/* Ascii 23 */
	{0x18, 0x7e, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},	/* Ascii 24 */
	{0x18, 0x18, 0x18, 0x18, 0x18, 0x7e, 0x18, 0x00},	/* Ascii 25 */
	{0x00, 0x04, 0x06, 0xff, 0x06, 0x04, 0x00, 0x00},	/* Ascii 26 */
	{0x00, 0x20, 0x60, 0xff, 0x60, 0x20, 0x00, 0x00},	/* Ascii 27 */
	{0x00, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0xff, 0x00},	/* Ascii 28 */
	{0x00, 0x24, 0x66, 0xff, 0x66, 0x24, 0x00, 0x00},	/* Ascii 29 */
	{0x00, 0x00, 0x10, 0x38, 0x7c, 0xfe, 0x00, 0x00},	/* Ascii 30 */
	{0x00, 0x00, 0x00, 0xfe, 0x7c, 0x38, 0x10, 0x00},	/* Ascii 31 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},	/* */
	{0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x30, 0x00},	/* ! */
	{0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},	/* " */
	{0x6c, 0x6c, 0xfe, 0x6c, 0xfe, 0x6c, 0x6c, 0x00},	/* # */
	{0x10, 0x7c, 0xd2, 0x7c, 0x86, 0x7c, 0x10, 0x00},	/* $ */
	{0xf0, 0x96, 0xfc, 0x18, 0x3e, 0x72, 0xde, 0x00},	/* % */
	{0x30, 0x48, 0x30, 0x78, 0xce, 0xcc, 0x78, 0x00},	/* & */
	{0x0c, 0x0c, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},	/* ' */
	{0x10, 0x60, 0xc0, 0xc0, 0xc0, 0x60, 0x10, 0x00},	/* ( */
	{0x10, 0x0c, 0x06, 0x06, 0x06, 0x0c, 0x10, 0x00},	/* ) */
	{0x00, 0x54, 0x38, 0xfe, 0x38, 0x54, 0x00, 0x00},	/* * */
	{0x00, 0x18, 0x18, 0x7e, 0x18, 0x18, 0x00, 0x00},	/* + */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x70},	/* , */
	{0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00},	/* - */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00},	/* . */
	{0x02, 0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x00},	/* / */
	{0x7c, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0x7c, 0x00},	/* 0 */
	{0x18, 0x38, 0x78, 0x18, 0x18, 0x18, 0x3c, 0x00},	/* 1 */
	{0x7c, 0xc6, 0x06, 0x0c, 0x30, 0x60, 0xfe, 0x00},	/* 2 */
	{0x7c, 0xc6, 0x06, 0x3c, 0x06, 0xc6, 0x7c, 0x00},	/* 3 */
	{0x0e, 0x1e, 0x36, 0x66, 0xfe, 0x06, 0x06, 0x00},	/* 4 */
	{0xfe, 0xc0, 0xc0, 0xfc, 0x06, 0x06, 0xfc, 0x00},	/* 5 */
	{0x7c, 0xc6, 0xc0, 0xfc, 0xc6, 0xc6, 0x7c, 0x00},	/* 6 */
	{0xfe, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x60, 0x00},	/* 7 */
	{0x7c, 0xc6, 0xc6, 0x7c, 0xc6, 0xc6, 0x7c, 0x00},	/* 8 */
	{0x7c, 0xc6, 0xc6, 0x7e, 0x06, 0xc6, 0x7c, 0x00},	/* 9 */
	{0x00, 0x30, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00},	/* : */
	{0x00, 0x30, 0x00, 0x00, 0x00, 0x30, 0x20, 0x00},	/* right brace */
	{0x00, 0x1c, 0x30, 0x60, 0x30, 0x1c, 0x00, 0x00},	/* < */
	{0x00, 0x00, 0x7e, 0x00, 0x7e, 0x00, 0x00, 0x00},	/* = */
	{0x00, 0x70, 0x18, 0x0c, 0x18, 0x70, 0x00, 0x00},	/* > */
	{0x7c, 0xc6, 0x0c, 0x18, 0x30, 0x00, 0x30, 0x00},	/* ? */
	{0x7c, 0x82, 0x9a, 0xaa, 0xaa, 0x9e, 0x7c, 0x00},	/* @ */
	{0x38, 0x6c, 0xc6, 0xc6, 0xfe, 0xc6, 0xc6, 0x00},	/* A */
	{0xfc, 0xc6, 0xc6, 0xfc, 0xc6, 0xc6, 0xfc, 0x00},	/* B */
	{0x7c, 0xc6, 0xc6, 0xc0, 0xc0, 0xc6, 0x7c, 0x00},	/* C */
	{0xf8, 0xcc, 0xc6, 0xc6, 0xc6, 0xcc, 0xf8, 0x00},	/* D */
	{0xfe, 0xc0, 0xc0, 0xfc, 0xc0, 0xc0, 0xfe, 0x00},	/* E */
	{0xfe, 0xc0, 0xc0, 0xfc, 0xc0, 0xc0, 0xc0, 0x00},	/* F */
	{0x7c, 0xc6, 0xc0, 0xce, 0xc6, 0xc6, 0x7e, 0x00},	/* G */
	{0xc6, 0xc6, 0xc6, 0xfe, 0xc6, 0xc6, 0xc6, 0x00},	/* H */
	{0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00},	/* I */
	{0x1e, 0x06, 0x06, 0x06, 0xc6, 0xc6, 0x7c, 0x00},	/* J */
	{0xc6, 0xcc, 0xd8, 0xf0, 0xd8, 0xcc, 0xc6, 0x00},	/* K */
	{0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xfe, 0x00},	/* L */
	{0xc6, 0xee, 0xfe, 0xd6, 0xc6, 0xc6, 0xc6, 0x00},	/* M */
	{0xc6, 0xe6, 0xf6, 0xde, 0xce, 0xc6, 0xc6, 0x00},	/* N */
	{0x7c, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0x7c, 0x00},	/* O */
	{0xfc, 0xc6, 0xc6, 0xfc, 0xc0, 0xc0, 0xc0, 0x00},	/* P */
	{0x7c, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0x7c, 0x06},	/* Q */
	{0xfc, 0xc6, 0xc6, 0xfc, 0xc6, 0xc6, 0xc6, 0x00},	/* R */
	{0x78, 0xcc, 0x60, 0x30, 0x18, 0xcc, 0x78, 0x00},	/* S */
	{0xfc, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00},	/* T */
	{0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0x7c, 0x00},	/* U */
	{0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0x6c, 0x38, 0x00},	/* V */
	{0xc6, 0xc6, 0xc6, 0xd6, 0xfe, 0xee, 0xc6, 0x00},	/* W */
	{0xc6, 0xc6, 0x6c, 0x38, 0x6c, 0xc6, 0xc6, 0x00},	/* X */
	{0xc3, 0xc3, 0x66, 0x3c, 0x18, 0x18, 0x18, 0x00},	/* Y */
	{0xfe, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0xfe, 0x00},	/* Z */
	{0x3c, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3c, 0x00},	/* [ */
	{0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x03, 0x00},	/* \ */
	{0x3c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x3c, 0x00},	/* ] */
	{0x00, 0x38, 0x6c, 0xc6, 0x00, 0x00, 0x00, 0x00},	/* ^ */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff},	/* _ */
	{0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},	/* ` */
	{0x00, 0x00, 0x7c, 0x06, 0x7e, 0xc6, 0x7e, 0x00},	/* a */
	{0xc0, 0xc0, 0xfc, 0xc6, 0xc6, 0xe6, 0xdc, 0x00},	/* b */
	{0x00, 0x00, 0x7c, 0xc6, 0xc0, 0xc0, 0x7e, 0x00},	/* c */
	{0x06, 0x06, 0x7e, 0xc6, 0xc6, 0xce, 0x76, 0x00},	/* d */
	{0x00, 0x00, 0x7c, 0xc6, 0xfe, 0xc0, 0x7e, 0x00},	/* e */
	{0x1e, 0x30, 0x7c, 0x30, 0x30, 0x30, 0x30, 0x00},	/* f */
	{0x00, 0x00, 0x7e, 0xc6, 0xce, 0x76, 0x06, 0x7c},	/* g */
	{0xc0, 0xc0, 0xfc, 0xc6, 0xc6, 0xc6, 0xc6, 0x00},	/* */
	{0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3c, 0x00},	/* i */
	{0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0xf0},	/* j */
	{0xc0, 0xc0, 0xcc, 0xd8, 0xf0, 0xd8, 0xcc, 0x00},	/* k */
	{0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00},	/* l */
	{0x00, 0x00, 0xcc, 0xfe, 0xd6, 0xc6, 0xc6, 0x00},	/* m */
	{0x00, 0x00, 0xfc, 0xc6, 0xc6, 0xc6, 0xc6, 0x00},	/* n */
	{0x00, 0x00, 0x7c, 0xc6, 0xc6, 0xc6, 0x7c, 0x00},	/* o */
	{0x00, 0x00, 0xfc, 0xc6, 0xc6, 0xe6, 0xdc, 0xc0},	/* p */
	{0x00, 0x00, 0x7e, 0xc6, 0xc6, 0xce, 0x76, 0x06},	/* q */
	{0x00, 0x00, 0x6e, 0x70, 0x60, 0x60, 0x60, 0x00},	/* r */
	{0x00, 0x00, 0x7c, 0xc0, 0x7c, 0x06, 0xfc, 0x00},	/* s */
	{0x30, 0x30, 0x7c, 0x30, 0x30, 0x30, 0x1c, 0x00},	/* t */
	{0x00, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0x7e, 0x00},	/* u */
	{0x00, 0x00, 0xc6, 0xc6, 0xc6, 0x6c, 0x38, 0x00},	/* v */
	{0x00, 0x00, 0xc6, 0xc6, 0xd6, 0xfe, 0x6c, 0x00},	/* w */
	{0x00, 0x00, 0xc6, 0x6c, 0x38, 0x6c, 0xc6, 0x00},	/* x */
	{0x00, 0x00, 0xc6, 0xc6, 0xce, 0x76, 0x06, 0x7c},	/* y */
	{0x00, 0x00, 0xfc, 0x18, 0x30, 0x60, 0xfc, 0x00},	/* z */
	{0x0e, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0e, 0x00},	/* { */
	{0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00},	/* | */
	{0xe0, 0x30, 0x30, 0x1c, 0x30, 0x30, 0xe0, 0x00},	/* } */
	{0x00, 0x00, 0x70, 0x9a, 0x0e, 0x00, 0x00, 0x00},	/* ~ */
	{0x00, 0x00, 0x18, 0x3c, 0x66, 0xff, 0x00, 0x00}	/* Ascii 127 */
};

/* static char xystring[] = "4507430165672321"; */
int     xyincrs[] = {
	-1, 0, -1, -1,		/* 0 */
	1, 0, 1, -1,		/* 1 */
	-1, 0, -1, 1,		/* 2 */
	1, 0, 1, 1,		/* 3 */
	0, -1, -1, -1,		/* 4 */
	0, -1, 1, -1,		/* 5 */
	0, 1, -1, 1,		/* 6 */
	0, 1, 1, 1		/* 7 */
};

int     sindex, delta, ix, iy, xincr, yincr, count;

void
xywrite()
{
	Screen[oy][ox] = WriteStyle;
	sindex = 0;
	if ((ix = (ox - x)) < 0) {
		++sindex;
		ix = -ix;
	}
	if ((iy = oy - y) < 0) {
		sindex += 2;
		iy = -iy;
	}
	if (iy > ix)
		sindex += 4;
	else if (ix > iy) {
		delta = ix;
		ix = iy;
		iy = delta;
	}
	if (iy == 0)
		return;
	count = iy;
	ix <<= 1;
	delta = ix - iy;
	iy <<= 1;
	/* fprintf(stderr, "sindex %d delta %d\n", sindex, delta); */
	sindex <<= 2;

	while (--count >= 0) {
		if (delta >= 0) {
			ox += xyincrs[sindex + 2];
			oy += xyincrs[sindex + 3];
			delta -= iy;
		} else {
			ox += xyincrs[sindex];
			oy += xyincrs[sindex + 1];
		}
		Screen[oy][ox] = WriteStyle;
		delta += ix;
	}

	ox = x;
	oy = y;
}

int
uniplot(f)
	FILE   *f;
{
	register i, j, k, c, d;
	int     didly = 0;
	/* done with y bytes */
	x = 0;
	y = SSIZE * 3 / 4;
	int     chsize = 4;
again:
	if ((c = getc(f)) == EOF)
		return EOF;
	c &= 0177;
	if (c < 040) {
		switch (c) {
		case BS:
			x -= CharSpacing[chsize];
			if (x < 0)
				x = 0;
			goto again;
		case VT:
			if ((y += LineSpacing[chsize]) > 3072)
				y = 3072;
			goto again;
		case HT:
			x += CharSpacing[chsize];
			if (x > 2090)
				x = 0;
			else
				goto again;
		case LF:
			if ((y -= LineSpacing[chsize]) < 0)
				y = 0;
			if (!Option_n)
				goto again;
			/* FALLTHROUGH */
		case CR:
			mode = ALPHA;
			x = 0;
			goto again;
		case ESC:
	moreesc:
			if ((c = getc(f)) == EOF)
				return EOF;
			c &= 0177;
			if (c >= 96 && c <= 116) {
				WriteStyle = c + 137;
				goto again;
			}
			switch (c) {
			case FS:
				mode = SPOINTFETCH;
				break;
			case FF:
				Screeninit();
				break;
			case DEL:
				goto moreesc;
			case '?':
				c = 0177;
				goto escques;
			case '8':
				chsize = 1;
				break;
			case '9':
				chsize = 2;
				break;
			case ':':
				chsize = 3;
				break;
			case ';':
				chsize = 4;
				break;
			}
			goto again;
		case FS:
			didly = 0;
			mode = POINT;
			break;
		case GS:
			didly = 0;
			blank = mode = VECTOR;
			break;
		case RS:
			mode = IPLOT;
			break;
/*	causes some plots to hiccup!!
			case CR:
				ox = x = 0;
*/
			/* FALLTHROUGH */
		case US:
			mode = ALPHA;
			break;
		}
		goto again;
	}
escques:
	switch (mode) {
	case SPOINTFETCH:
		if (c >= 040 && c < 126) {
			++Nspp;
			Zaxis = c;
			mode = SPOINT;
		}
		goto again;
	case ALPHA:
		/* Screen[y][x] = WriteNorm; */
		/* unsigned char AsciiTable[][8] */
		if (Option_a || c < 32 || c > 126)
			goto again;
		for (k = 8; --k >= 0;) {
			d = AsciiTable[c][7 - k];
			for (j = 0, i = 0400; i >>= 1;) {
				if (d & i)
					Screen[y + k][x + j] = WriteStyle;
				++j;
			}
		}
		x += CharSpacing[chsize];
		if (x >= SSIZE) {
			x = 0;
			if ((y -= LineSpacing[chsize]) < 0)
				y = 0;
		}
		goto again;
	case IPLOT:
		switch (c) {
		case 32:
			Pendown = 0;
			goto again;
		case 80:
			Pendown = 1;
			break;
		case 68:
			++y;
			break;
		case 69:
			++x;
			++y;
			break;
		case 65:
			++x;
			break;
		case 73:
			++x;
			--y;
			break;
		case 72:
			--y;
			break;
		case 74:
			--y;
			--x;
			break;
		case 66:
			--x;
			break;
		case 70:
			--x;
			++y;
			break;
		default:
			goto again;
		}
		if (x >= SSIZE)
			x = SSIZE - 1;
		if (x < 0)
			x = 0;
		if (y > SSIZE)
			y = SSIZE - 1;
		if (y < 0)
			y = 0;
		if (Pendown) {
			++Nex;
			Screen[y][x] = Zaxis;
		}
		goto again;
	}
	switch (c & 0140) {
	case 0:		/* control char */
		break;
	case 0140:		/* low order y */
		if (didly) {
			x = (x & 0xFFFC) | (didly & 03);
			y = (y & 0xFFFC) | ((didly & 014) >> 2);
			if (didly & 017)
				++Nex;
		}
		y = (y & 0xFF83) | (((didly = c) & 037) << 2);
		break;
	case 040:
		if (didly)
			x = (x & 0x7F) | ((c & 037) << 7);
		else
			y = (y & 0x7F) | ((c & 037) << 7);
		break;
	case 0100:		/* low x and execute */
		didly = 0;
		x = (x & 0xFF83) | ((c & 037) << 2);
		switch (mode) {
		case SPOINT:
		case POINT:
			Screen[y][x] = Zaxis;

			Screen[y + 1][x] = Zaxis;
			Screen[y][x + 1] = Zaxis;
			Screen[y + 1][x + 1] = Zaxis;

			Screen[y + 2][x] = Zaxis;
			Screen[y][x + 2] = Zaxis;
			Screen[y + 2][x + 2] = Zaxis;

			Screen[y + 2][x + 1] = Zaxis;
			Screen[y + 1][x + 2] = Zaxis;

			PPHist[Zaxis & 0377]++;
			++Npoints;
			ox = x;
			oy = y;
			if (mode == SPOINT)
				mode = SPOINTFETCH;
			break;
		case VECTOR:
			if (blank == 0) {
				xywrite();
				++Nvectors;
			}
			ox = x;
			oy = y;
			blank = 0;
		}
		break;
	}
	goto again;
}

int
main(int argc, char **argv)
{
	FILE   *fd;
	int     i, j, n;
	if (argc != 2)
		return;

	fd = fopen(argv[1], "r");

	uniplot(fd);

#if 1
	printf("P2\n%i %i\n%i\n", SSIZE, SSIZE, 255);
	n = 0;
	for (i = SSIZE; --i >= 0;)
		for (j = 0; j < SSIZE; j++) {
			printf("%-4i", Screen[i][j]);
			if (++n > 16) {
				n = 0;
				printf("\n");
			}
		}
#endif

	fclose(fd);

	return 0;
}
